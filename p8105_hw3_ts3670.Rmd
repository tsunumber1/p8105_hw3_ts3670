---
title: "p8105_hw3_ts3670"
author: "Tong Su"
date: "2024-10-16"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggridges)
library(patchwork)

library(p8105.datasets) 

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8,
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1
```{r}
data("ny_noaa")
```

## Problem 2
```{r}
accelerometer_df = read_csv("./data/nhanes_accel.csv") |>
  janitor::clean_names()

demographics_df = read_csv("./data/nhanes_covar.csv",skip = 4)|> 
  filter(age >= 21) |>
  janitor::clean_names()
```

```{r}
MIMS_df = 
  inner_join(demographics_df,accelerometer_df, by = "seqn")|>
  drop_na(sex, age, bmi, education) |>
  pivot_longer(cols = starts_with("min"),
               names_to = "minute",
               values_to = "acc") |>
  mutate(sex = factor(sex,
                      levels = c(1, 2),
                      labels = c("Male", "Female"),
                      ordered = TRUE)) |>
  mutate(education = factor(education,
                            levels = c(1, 2, 3),
                            labels = c("Less than high school", "High school equivalent", "More than high school"),
                            ordered = TRUE))
```
First, we load both the demographic and accelerometer datasets for NHANES participants. To clean the data, I remove participants who are less than 21 years old and participants with missing demographic data.Also, ensure data are encoded in reasonable classes, categorical variables for sex and education.And then merge these two datasets into one combined dataset as `MIMS_df`

### Table of Men and Women in Each Education Category
```{r}
education_gender = MIMS_df |>
  group_by(education, sex) |>
  summarise(count = n()) |>
  spread(key = sex, value = count, fill = 0)

education_gender
```
This is a summary table that shows the number of men and women in each education category. There are more female participants with the education background of `Less than high school` and `More than high school` and more male participants with `High school equivalent` education background.

### Visualize the Age Distributions by Education and Sex
```{r}
  ggplot(MIMS_df, aes(x = age, fill = sex)) +
  geom_density(alpha = .5) + 
  facet_grid(education ~ sex) +
  labs(title = "Age Distribution by Education Level and Sex",
       x = "Age",
       y = "Density") 
```
The density graph shows the age distribution of male and females of three education level. 

### Total Activity and Plot Total Activity vs. Age
```{r}
total_activity_data = MIMS_df |>
  group_by(seqn, sex, age, education) |>
  summarize(total_activity = sum(acc, na.rm = TRUE))

ggplot(total_activity_data, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "loess", se = FALSE) +  
  facet_wrap(~education) +  
  labs(title = "Total Activity vs. Age by Sex and Education Level",
       x = "Age",
       y = "Total Activity") +
  theme_minimal()
```
We first sum the minute-by-minute data to `total_activity` for each individual and then create scatter plots with smooth curves for males and females, divided into three panels based on education level. The curves show that males with less than a high school education are generally more active than females in the same group, while for those with a high school education or higher, females tend to be more active than males. As expected, activity decreases with age, and people from different education levels exhibit peak activity at varying ages. The overall analysis highlights gender differences in activity across education levels, particularly among younger individuals, with a general decline in activity as age increases.

### Create a 24-Hour Activity Time Course Plot by Education and Sex
```{r}
time_course_data <- MIMS_df |>
  group_by(minute, sex, education) %>%
  summarize(mean_activity = mean(acc, na.rm = TRUE))

ggplot(time_course_data, aes(x = as.numeric(gsub("min", "", minute)), y = mean_activity, color = sex)) +
  geom_point( alpha = 0.5) +
  geom_smooth(se = FALSE, method = "loess") + 
  facet_wrap(~education) +
  labs(title = "24-Hour Activity Time Course by Education Level and Sex",
       x = "Time (Minutes from Start of Day)",
       y = "Mean Activity Level",
       color = "Sex") +
  theme_minimal()
```
When observing the smooth curves for males and females, their daily activity patterns appear quite similar across all three education levels.  Additionally, there is no notable difference in activity trends between the different education levels.

## Problem 3
```{r}
jan_2020 = read.csv("./data/citibike/Jan 2020 Citi.csv") |>
  mutate(year = as.factor(2020), month = as.factor(1)) |>
  janitor::clean_names() 

jan_2024 = read.csv("./data/citibike/Jan 2024 Citi.csv") |>
  mutate(year = as.factor(2024), month = as.factor(1)) |>
  janitor::clean_names()

july_2020 = read.csv("./data/citibike/July 2020 Citi.csv") |>
  mutate(year = as.factor(2020), month = as.factor(7)) |>
  janitor::clean_names()

july_2024 = read.csv("./data/citibike/July 2024 Citi.csv") |>
  mutate(year = as.factor(2024), month = as.factor(7)) |>
  janitor::clean_names()

combined_data = bind_rows(jan_2020, jan_2024, july_2020, july_2024) |>
  select(ride_id:rideable_type, year, month, everything()) |>
  mutate(
    rideable_type = as.factor(rideable_type),
    weekdays = as.factor(weekdays),
    duration = as.numeric(duration),
    start_station_name = as.factor(start_station_name),
    end_station_name = as.factor(end_station_name),
    member_casual = as.factor(member_casual)
  ) |>
  na.omit()
```

The combined Citi Bike dataset contains ride information for four different months: January 2020, July 2020, January 2024, and July 2024, including 9 columns of key components: `ride_id`, `rideable_type`- `classic_bike` and `electric_bike`, `weekdays`, `duration`, `start_station_name`, `end_station_name`, `member_casual`, `year`, `month`. The dataset represents 1% of all rides taken with a duration of less than 4 hours.


### Total Rides by Year, Month, and Membership Status:
```{r}
ride_summary = combined_data |>
  group_by(year, month, member_casual) |>
  summarise(total_rides = n()) |>
  pivot_wider(names_from = member_casual, values_from = total_rides, names_prefix = "num_")

ride_summary
```
In both 2020 and 2024, July has more causal rides and members than January, likely due to more favorable weather for cycling during the summer. So we can infer that weather does play a critical role in bike usage, with summer months seeing increased activity. 

### Top 5 Most Popular Starting Stations in July 2024
```{r}
popstations_july_2024 = july_2024 |>
  filter(year == 2024, month == 7) |>
  group_by(start_station_name) |>
  summarise(num_rides = n()) |>
  arrange(desc(num_rides)) |>
  head(n = 5)

popstations_july_2024
```
The most popular stations in July 2024 are well-located, central stations like `Pier 61 at Chelsea Piers` and `University Pl & E 14 St`. These stations serve key areas of Manhattan, known for high foot traffic and tourist activity.

### Median Ride Duration by Weekday, Month, and Year
```{r}
duration_plot = combined_data |>
  mutate(weekdays = factor(weekdays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))) |>
  group_by(year, month, weekdays) |>
  summarise(median_dur = median(duration)) |>
  ggplot(aes(x = weekdays, y = median_dur, fill = month)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~year) +
  labs(title = "Median Ride Duration by Weekday, Month, and Year",
       x = "Weekday", y = "Median Duration", fill = "Month")

duration_plot
```
Rides on weekends tend to have longer median durations compared to weekdays, and rides in July have longer median durations than in January, and this pattern is consistent across both years. This suggests that for weekend and July, people may use Citi Bikes for longer, the reason might be that people are more likely to have leisure rides in addition to commuting on weekends and warm days.

### Ride Duration Distribution by Month, Membership Status, and Bike Type in 2024
```{r}
duration_2024_plot = combined_data |> 
  filter(year == 2024)|>
  ggplot(aes(x = month, y = duration, fill = interaction(member_casual, rideable_type))) +
  geom_violin(scale = "width", trim = FALSE) +
  labs(title = "Ride Duration Distribution by Month and Membership Status (2024)",
       x = "Month", y = "Ride Duration (minutes)") +
  theme_minimal() +
  theme(legend.title = element_blank())

duration_2024_plot
```

This violin plot shows that "casual" riders tend to have a wider distribution of ride duration compared to members, particularly in July. Members typically exhibit shorter, more consistent ride durations. Electric bikes also show shorter and more concentrated ride times.
